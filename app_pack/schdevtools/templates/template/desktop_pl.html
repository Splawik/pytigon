{% extends 'template/desktop_base.html'|translate:lang %}
{% load exfiltry %}
{% load exsyntax %}
{% load bootstrap4 %}
{% load staticfiles %}
{% block js_extrascipts %}
        {{block.super}}
        {% jscript_link 'vue/vue.js' %}
        {% jscript_link 'app/schdevtools/js/test_javascript.js' %}
        {% jscript_link 'app/schdevtools/js/test_python.js' %}
        <script src="https://unpkg.com/xterm@3.6.0/dist/xterm.js"></script>
        <script src="https://unpkg.com/xterm@3.6.0/dist/addons/fit/fit.js"></script>
{% endblock %}
{% block extrastyle %}
        {{block.super}}
        {% css_link 'app/schdevtools/css/style.css' %}
        {% css_link 'app/schdevtools/css/test_icss.css' %}
        {% css_link 'app/_schwiki/css/wiki_editor.css' %}
{% endblock %}
{% block body_footer %}
        {{block.super}}
        <script>
          // Terminal.applyAddon(fullscreen)
          var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
          var address = protocol + window.location.host +'/schcommander/shell/';
          var websocket = new WebSocket(address);
          Terminal.applyAddon(fit)
          const term = new Terminal();
          term.open(document.getElementById('terminal'));
          term.fit()
          term.resize(50, 15)
          //console.log(`size: ${term.cols} columns, ${term.rows} rows`)
          // term.toggleFullScreen(true)
          term.fit()
          term.on('key', (key, ev) => {
            //console.log("pressed key", key);
            //console.log("event", ev);
            var txt = JSON.stringify({ input: key });
            //console.log("txt", txt);
            websocket.send(txt);
          });
          websocket.onmessage = function(evt)  {
            //console.log("client onmessage", evt.data)
            term.write(evt.data);
          }
          function fitToscreen(){
            term.fit()
            websocket.send(JSON.stringify({resize: {"cols": term.cols, "rows": term.rows}}))
          }
          function debounce(func, wait_ms) {
            let timeout
            return function(...args) {
              const context = this
              clearTimeout(timeout)
              timeout = setTimeout(() => func.apply(context, args), wait_ms)
            }
          }
          const wait_ms = 50;
          window.onresize = debounce(fitToscreen, wait_ms)
</script>
        <div style="width: 100%; height: calc(100% - 50px);" id="terminal"></div>
        {% component 'app/standard_components/components/summernote.js' %}
        {% component 'app/standard_components/components/plotly.js' %}
        {% component 'app/schdevtools/components/test.js' %}
        {% component 'app/standard_components/components/leaflet.js' %}
        {% component 'app/standard_components/components/d3.js' %}
        {% component 'app/standard_components/components/code_editor.js' %}
        {% component 'app/standard_components/components/handsontable.js' %}
        {% component 'app/standard_components/components/vs_editor.js' %}
        {% component 'app/standard_components/components/pivottable.js' %}
        {% component 'app/standard_components/components/txtarea_editor.js' %}
        {% component 'app/standard_components/components/video-js.js' %}
        <link rel="stylesheet" href="https://unpkg.com/xterm@3.6.0/dist/xterm.css" />
{% endblock %}
{% block component_init %}
        component_init = [ "summernote", "plotly", "test", "leaflet", "d3", "code_editor", "handsontable", "vs_editor", "pivottable", "txtarea_editor", "video-js",  ]
{% endblock %}
{% block botstrap_css %}
        {% css_link 'themes/bootswatch/materia/bootstrap.min.css' %}
{% endblock %}
{% block js_app_init %}
        db_struct = [ ["devparam", {"keyPath": "key"}] ];
        init_db(db_struct);
        devtools_sync = function(run_after) {
            console.log("SYNC!");
            run_after("OK");
        }
        sync_struct = [ ['devparam', "{{base_path}}schdevtools/devparam/", devtools_sync], ];
        init_sync(sync_struct);
        {{ block.super }}
{% endblock %}
{% block logo %}
        <span class="logo-lg">
                <img src="{{base_path}}static/favicon.ico" style="height:100%;"></img>
                <span class="txt3d text-white" style="font-size:1rem;">
                        Pytigon - dev tools
                </span>
        </span>
{% endblock %}

